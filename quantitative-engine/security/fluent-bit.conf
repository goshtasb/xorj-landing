# XORJ Quantitative Engine - Fluent Bit Configuration for SR-3
# Immutable log collection and forwarding

[SERVICE]
    Flush         1
    Log_Level     info
    Daemon        off
    Parsers_File  parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020

# SR-3: Audit Log Collection - JSONL format
[INPUT]
    Name              tail
    Path              /logs/audit_*.jsonl
    Tag               audit.xorj
    Parser            json
    Refresh_Interval  5
    Rotate_Wait      30
    DB                /tmp/audit_tail.db
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Skip_Empty_Lines  On

# Application Logs Collection
[INPUT]
    Name              tail
    Path              /logs/app*.log
    Tag               app.xorj
    Parser            json
    Refresh_Interval  5
    Rotate_Wait      30
    DB                /tmp/app_tail.db
    Mem_Buf_Limit     50MB

# Error Logs Collection
[INPUT]
    Name              tail
    Path              /logs/error*.log
    Tag               error.xorj
    Multiline         On
    Parser_Firstline  error_start
    Refresh_Interval  5
    DB                /tmp/error_tail.db

# SR-3: Add immutability metadata to all logs
[FILTER]
    Name record_modifier
    Match *
    Record hostname ${HOSTNAME}
    Record container_id ${CONTAINER_ID}
    Record collection_timestamp ${TIMESTAMP}
    Record log_source xorj-quantitative-engine
    Record security_requirement SR-3

# Add checksums for integrity verification
[FILTER]
    Name lua
    Match audit.*
    Script /fluent-bit/scripts/integrity.lua
    Call add_integrity_hash

# SR-3: Audit log validation - ensure no tampering
[FILTER]
    Name grep
    Match audit.*
    Regex log ^(?=.*event_id)(?=.*checksum).*$

# Parse and validate JSON structure
[FILTER]
    Name parser
    Match audit.*
    Key_Name log
    Parser audit_json
    Preserve_Key Off
    Reserve_Data On

# SR-3: Output to immutable storage (S3 or similar)
[OUTPUT]
    Name              s3
    Match             audit.*
    bucket            xorj-audit-logs-${ENVIRONMENT}
    region            us-east-1
    s3_key_format     /audit/%Y/%m/%d/audit-${HOSTNAME}-%Y%m%d%H%M%S-${UUID}.jsonl
    total_file_size   100M
    upload_timeout    300s
    use_put_object    On
    compression       gzip
    content_type      application/x-ndjson
    
# Application logs to CloudWatch/similar
[OUTPUT]
    Name              cloudwatch_logs
    Match             app.*
    region            us-east-1
    log_group_name    /xorj/quantitative-engine/${ENVIRONMENT}/application
    log_stream_prefix ${HOSTNAME}-
    auto_create_group On

# Error logs with high priority
[OUTPUT]
    Name              cloudwatch_logs
    Match             error.*
    region            us-east-1
    log_group_name    /xorj/quantitative-engine/${ENVIRONMENT}/errors
    log_stream_prefix ${HOSTNAME}-error-
    auto_create_group On

# Local backup for critical audit events
[OUTPUT]
    Name              file
    Match             audit.*
    Path              /logs/backup/
    File              audit-backup.jsonl
    Format            json_lines

# Development output (commented for production)
# [OUTPUT]
#     Name              stdout
#     Match             *
#     Format            json_lines